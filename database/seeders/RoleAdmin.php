<?php

namespace Database\Seeders;

use Illuminate\Database\Seeder;
use Spatie\Permission\Models\Role;
use Spatie\Permission\Models\Permission;

class RoleAdmin extends Seeder
{
    public function run(): void
    {
        app()[\Spatie\Permission\PermissionRegistrar::class]->forgetCachedPermissions();

        $guard = 'web';

        // 1) تجميع الصلاحيات بمجموعات
        $groups = [
            'لوحة التحكم' => [
                'الدخول إلى لوحة التحكم',
                'عرض التحليلات',
                'عرض التقارير العامة',
            ],
            'المستخدمون' => [
                'عرض المستخدمين',
                'إضافة مستخدم',
                'تعديل مستخدم',
                'حذف مستخدم',
                'إدارة الأدوار',
                'إدارة الصلاحيات',
                'تعطيل/تفعيل مستخدم',
                'عرض سجل النشاط',
            ],
            'الدورات' => [
                'عرض الدورات',
                'إنشاء دورة',
                'تعديل دورة',
                'حذف دورة',
                'نشر دورة',
                'إلغاء نشر دورة',
                'أرشفة دورة',
                'إدارة مدرّسي الدورة',
            ],
            'الدروس' => [
                'عرض الدروس',
                'إنشاء درس',
                'تعديل درس',
                'حذف درس',
                'ترتيب الدروس',
            ],
            'ملفات الدرس' => [
                'رفع ملف للدرس',
                'حذف ملف للدرس',
                'تنزيل ملف الدرس',
            ],
            'الاختبارات والبنك' => [
                'عرض بنك الأسئلة',
                'إضافة سؤال',
                'تعديل سؤال',
                'حذف سؤال',
                'إنشاء اختبار',
                'تعديل اختبار',
                'حذف اختبار',
                'نشر اختبار',
                'إلغاء نشر اختبار',
                'تصحيح محاولات الاختبار',
            ],
            'التسجيلات والاشتراكات' => [
                'عرض التسجيلات',
                'إضافة تسجيل',
                'إلغاء تسجيل',
                'إدارة اشتراكات المعلمين',
                'إدارة اشتراكات الطلاب',
            ],
            'الدرجات' => [
                'عرض الدرجات',
                'إدخال الدرجات',
                'تعديل الدرجات',
                'تصدير الدرجات',
            ],
            'التفاعل' => [
                'نشر إعلان',
                'عرض أسئلة الطلاب',
                'الرد على أسئلة الطلاب',
                'حذف/إخفاء سؤال',
                'عرض التعليقات',
                'حذف التعليقات',
            ],
            'الجلسات المباشرة' => [
                'جدولة جلسة',
                'تعديل جلسة',
                'حذف جلسة',
                'بدء جلسة',
                'إنهاء جلسة',
            ],
            'الشهادات' => [
                'تهيئة قوالب الشهادات',
                'إصدار شهادة',
                'إلغاء شهادة',
            ],
            'المكتبة' => [
                'رفع وسائط',
                'حذف وسائط',
                'إدارة المجلدات',
            ],
            'المحتوى العام' => [
                'عرض الصفحات',
                'إضافة صفحة',
                'تعديل صفحة',
                'حذف صفحة',
                'عرض المقالات',
                'إضافة مقال',
                'تعديل مقال',
                'حذف مقال',
                'عرض التصنيفات',
                'إضافة تصنيف',
                'تعديل تصنيف',
                'حذف تصنيف',
                'إدارة الوسوم',
            ],
            'الدفع والتسويق' => [
                'عرض المدفوعات',
                'استرجاع دفعة',
                'إدارة أكواد الخصم',
                'إدارة العروض',
                'عرض أرباح المعلّم',
            ],
            'الإعدادات' => [
                'عرض الإعدادات',
                'تعديل الإعدادات',
                'إدارة النسخ الاحتياطي',
                'إعدادات التكاملات',
            ],
            'الطالب' => [
                'الانضمام إلى دورة',
                'الانسحاب من دورة',
                'محاولة اختبار',
                'إرسال واجب',
                'رؤية درجاتي',
                'طرح سؤال',
                'تنزيل الموارد',
            ],
        ];

        // 2) إنشاء/تحديث كل الصلاحيات
        foreach ($groups as $groupName => $names) {
            foreach ($names as $name) {
                Permission::updateOrCreate(
                    ['name' => $name, 'guard_name' => $guard],
                    ['group_name' => $groupName]
                );
            }
        }

        // 3) إنشاء الأدوار
        $admin   = Role::firstOrCreate(['name' => 'admin',   'guard_name' => $guard]);
        $teacher = Role::firstOrCreate(['name' => 'teacher', 'guard_name' => $guard]);
        $student = Role::firstOrCreate(['name' => 'student', 'guard_name' => $guard]);

        // 4) إسناد الصلاحيات للأدوار

        // الأدمن: كل شيء
        $admin->syncPermissions(Permission::all());

        // المعلّم: إدارة المحتوى التعليمي الخاص به + التفاعل + عرض أرباحه
        $teacherAllowed = array_merge(
            $groups['الدورات'],
            $groups['الدروس'],
            $groups['ملفات الدرس'],
            $groups['الاختبارات والبنك'],
            $groups['التسجيلات والاشتراكات'],   // إن أردت تقييدها لاحقًا بواجهة مُعلّم فقط، اترك فقط "عرض التسجيلات"
            $groups['الدرجات'],
            $groups['التفاعل'],
            $groups['الجلسات المباشرة'],
            $groups['الشهادات'],
            $groups['المكتبة'],
            [
                'عرض الصفحات',
                'عرض المقالات',
                'عرض التصنيفات',
                'إدارة الوسوم', // قراءة عامة
                'عرض أرباح المعلّم', // من "الدفع والتسويق"
            ]
        );
        // إن لم ترغب أن يعدّل المعلّم صفحات/مقالات الموقع العام، لا تضف (إضافة/تعديل/حذف صفحة/مقال)
        $teacher->syncPermissions(Permission::whereIn('name', $teacherAllowed)->get());

        // الطالب: استخدام أساسي
        $studentAllowed = array_merge(
            [
                'عرض الصفحات',
                'عرض المقالات',
                'عرض التصنيفات',
            ],
            $groups['الطالب'] // الانضمام/محاولة اختبار/إرسال واجب/رؤية درجاتي/طرح سؤال/تنزيل الموارد
        );
        $student->syncPermissions(Permission::whereIn('name', $studentAllowed)->get());
    }
}
